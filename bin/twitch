#!/usr/bin/env ruby

require 'shellwords'
require 'pathname'
require 'uri'

RC_FILE = Pathname.new(Dir.home).join(".twitchrc")
TOKEN_FILE = Pathname.new(Dir.home).join(".twitch_token")
HIST_FILE = Pathname.new(Dir.home).join(".twitch_history")

def twitch_token
  ENV["TWITCH_TOKEN"] ||= if TOKEN_FILE.exist?
    TOKEN_FILE.read
  else
    $stdout.print "Please enter your twitch oauth token: "
    $stdout.flush
    $stdin.gets.tap do |token|
      $stdout.puts "Saving token to #{TOKEN_FILE}."
      TOKEN_FILE.write token
    end
  end.chomp
end

def from_url(url, options)
  no_terms = ['0', 'no', 'false']
  yes_terms = ['1', 'yes', 'true']
  uri = URI(url)
  if uri.query
    params = Hash[URI.decode_www_form(uri.query)]
    chat, args, quality, quiet = [
      params["chat"] || '',
      params["livestreamer_args"] || '',
      params["quality"] || '',
      params["quiet"] || ''
    ]
    options[:chat] = false if no_terms.include? chat.downcase
    options[:quiet] = true if yes_terms.include? quiet.downcase
    options[:quality] = quality unless quality.empty?
    options[:livestreamer_options].push(args) unless args.empty?
  end
  uri.host
end

options = {
  chat: true,
  stream: true,
  quiet: false,
  livestreamer_options: [],
  quality: [
    "source",
    "best",
    "1080p",
    "1080p60",
    "1080p30",
    "720p",
    "720p60",
    "720p30",
    "540p",
    "540p60",
    "540p30",
    "480p",
    "480p60",
    "480p30",
    "144p"
  ].join(",")
}
stream = nil
cmd = ARGV.shift
loop do
  case cmd
  when "--no-chat", "-C"
    options[:chat] = false
  when "--no-stream", "-S"
    options[:stream] = false
  when "--quality", "-q", /^(?:-q|--quality=)(.+)$/
    options[:quality] = $1 || ARGV.shift
  when "--quiet", "-Q"
    options[:quiet] = true
    options[:livestreamer_options] << "-Q"
  when nil
    if stream.nil?
      $stderr.puts "no stream provided."
      exit 1
    end
    channel = "https://www.twitch.tv/#{stream}"
    cmd = [
      "livestreamer",
      "--twitch-oauth-token",
      twitch_token,
      "--stream-segment-threads",
      5,
      *options[:livestreamer_options],
      channel,
      options[:quality]
    ].shelljoin
    $stdout.puts "Opening #{channel}" unless options[:quiet]
    system ["open", "#{channel.downcase}/chat"].shelljoin if options[:chat]
    $stdout.puts cmd.sub(twitch_token, "*****") unless options[:quiet]
    exec(cmd) if options[:stream]
    break
  when "--"
    options[:livestreamer_options].push *ARGV
    ARGV.clear
  else
    stream = cmd.start_with?('twitch://') ? from_url(cmd, options) : cmd
  end
  cmd = ARGV.shift
end
